<div id="accounts"></div>
<div style="text-align: center">
  <a href="#new" class="button">
    Add Account
  </a>
</div>

<style>
  #accounts {
    width: 100%;
    margin: var(--spacing-xxl) auto;
  }

  @media (min-width: 600px) {
    #accounts {
      max-width: 440px;
    }
  }

  .account.undelegated {
    --color--account-header: var(--blue-300);
    --color--account-location: var(--blue-800);
    --color--account-validator-status: var(--blue-700);
    --color--account-body: var(--blue-100);
    --color--account-actions--cta: var(--blue-500);
    --color--account-actions--delete: var(--blue-200);
    --color--account-actions--delete__icon: var(--blue-700);
    --color--accounts-label: var(--blue-700);
    --color--accounts-divider: var(--blue-200);
    --color--footer: var(--blue-200);
    --color--footer-text: var(--blue-500);
    --color--footer-caret: var(--blue-500);
  }
  .account.validator-active {
    --color--account-header: var(--green-300);
    --color--account-location: var(--green-800);
    --color--account-validator-status: var(--green-700);
    --color--account-body: var(--green-100);
    --color--account-actions--cta: var(--green-600);
    --color--account-actions--delete: var(--green-200);
    --color--account-actions--delete__icon: var(--green-700);
    --color--accounts-label: var(--green-700);
    --color--accounts-divider: var(--green-200);
    --color--footer: var(--green-200);
    --color--footer-text: var(--green-600);
    --color--footer-caret: var(--green-500);
  }
  .account.validator-next,
  .account.validator-proposed {
    --color--account-header: var(--orange-300);
    --color--account-location: var(--orange-800);
    --color--account-validator-status: var(--orange-700);
    --color--account-body: var(--orange-100);
    --color--account-actions--cta: var(--orange-600);
    --color--account-actions--delete: var(--orange-200);
    --color--account-actions--delete__icon: var(--orange-700);
    --color--accounts-label: var(--orange-700);
    --color--accounts-divider: var(--orange-200);
    --color--footer: var(--orange-200);
    --color--footer-text: var(--orange-700);
    --color--footer-caret: var(--orange-500);
  }
  .account.validator-inactive {
    --color--account-header: var(--red-300);
    --color--account-location: var(--red-800);
    --color--account-validator-status: var(--red-700);
    --color--account-body: var(--red-100);
    --color--account-actions--cta: var(--red-600);
    --color--account-actions--delete: var(--red-200);
    --color--account-actions--delete__icon: var(--red-700);
    --color--accounts-label: var(--red-700);
    --color--accounts-divider: var(--red-200);
    --color--footer: var(--red-200);
    --color--footer-text: var(--red-600);
    --color--footer-caret: var(--red-500);
  }

  .account {
    background-color: var(--color--account-body);
    color: var(--color--accounts-label);
    font-size: var(--fs-small);
    overflow: hidden;
    margin-bottom: var(--input-height--small);
  }

  .account label {
    font-size: var(--fs-micro);
    color: var(--gray-500);
  }

  .account a {
    color: inherit;
    text-decoration: underline;
  }
  .account a:focus,
  .account a:hover {
    color: var(--color--footer-text);
  }

  @media (min-width: 600px) {
    .account {
      border-radius: var(--br-small);
    }
  }

  .account__header {
    background-color: var(--color--account-header);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-m);
  }

  h2.account__location {
    color: var(--color--account-location);
    font-size: var(--fs-heading-4);
    margin-bottom: var(--spacing-xs);
  }

  .account__validator-status {
    color: var(--color--account-validator-status);
    display: flex;
    align-items: center;
    font-size: var(--fs-micro);
  }

  .account__validator-status .icon {
    margin-right: var(--spacing-xs);
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    width: var(--spacing-m);
    height: var(--spacing-m);
  }

  .account.validator-active > header .account__validator-status .icon {
    background-image: url(img/wallet.svg);
  }

  .account.validator-proposed > header .account__validator-status .icon,
  .account.validator-next > header .account__validator-status .icon {
    background-image: url(img/alert-triangle.svg);
  }

  .account.validator-inactive > header .account__validator-status .icon {
    background-image: url(img/alert-circle.svg);
  }

  .account.undelegated > header .account__validator-status .icon:before {
    content: "â†’";
  }

  .account__actions {
    display: flex;
    height: 2.4em;
  }

  .account__actions .button--cta {
    background-color: var(--color--account-actions--cta);
    color: white;
    text-decoration: none;
  }

  /* ensure proper functionality whether link or button element */
  .account__actions .button--cta:hover,
  .account__actions .button--cta:focus {
    color: white;
  }

  .account__actions .button--delete {
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color--account-actions--delete) !important;
    margin-left: var(--spacing-s);
    padding: 0;
    width: var(--input-height--small);
  }

  .account__datum {
    border-top: 1px solid var(--color--accounts-divider);
    display: grid;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-s) var(--spacing-m);
    grid-column-gap: var(--spacing-m);
    grid-template-columns: 1fr 2fr;
  }

  .account__datum label {
    color: var(--color--accounts-label);
    font-size: var(--fs-micro);
    padding: 0;
    margin: 0;
  }

  .account__footer {
    position: relative;
    height: var(--input-height--small);
    transition: height 200ms;
  }

  .account__footer button {
    color: var(--color--footer-text);
    text-align: center;
    border-radius: 0;
    position: absolute;
    bottom: 0;
    z-index: 1;
    font-size: var(--fs-micro);
    background-color: var(--color--footer);
  }

  .account__footer button:before {
    display: inline-block;
    content: " ";
    height: 0.3em;
    width: 0.3em;
    border: 2.5px solid var(--color--footer-caret);
    border-left-color: transparent;
    border-top-color: transparent;
    transform: rotate(45deg);
    margin-right: 0.5em;
    position: relative;
    top: -0.1em;
  }

  .account__footer button span:before {
    content: "View ";
  }

  .account__footer.open button span:before {
    content: "Hide ";
  }

  .account__footer.open button:before {
    top: 0.1em;
    transform: rotate(225deg);
  }

  .account__details {
    margin: 0;
    position: absolute;
    width: 100%;
  }
</style>

<script>
  // tracks UI state for which accounts have "view details" open
  const openAccountDetails = {};

  document.querySelector("body").addEventListener("click", (event) => {
    const accountDetailsButton = event.target.closest(
      "[data-behavior=openAccountDetails]"
    );

    // no details button clicked, end here
    if (!accountDetailsButton) return;

    const account = accountDetailsButton.closest(".account").id;
    const footer = accountDetailsButton.closest("footer");
    openAccountDetails[account] = !openAccountDetails[account];
    footer.classList.toggle("open");
    adjustAccountDetailsHeights();
  });

  // adjust hard-coded heights for accounts details panels, to enable slide-out animation
  function adjustAccountDetailsHeights() {
    Array.from(document.querySelectorAll(".account")).map(account => {
      const footer = account.querySelector("footer");
      const button = footer.querySelector("button").getBoundingClientRect()
        .height;
      const details = footer.querySelector(".account__details").getBoundingClientRect()
        .height;
      footer.style.height = footer.classList.contains("open")
        ? `${button + details}px`
        : `${button}px`;
    });
  }

  const link = (account) => `
    <a
      class="ellipsis"
      href="${process.env.EXPLORER_URL}/accounts/${account}"
      target="_blank"
      title="${account}"
    >
      ${account}
    </a>
  `

  function displayValidatorStatus (status, earnings) {
    if (!status)
      return 'earn $NEAR, secure the network; <a target="_blank" href="https://docs.near.org/docs/validator/delegation">delegate</a>'
    if (status === 'active')
      return `${window.utils.formatLargeNum(earnings)} $NEAR earned so far`
    if (status === 'next')
      return 'validator <a target="_blank" href="https://explorer.near.org/nodes/validators">inactive</a>; active next epoch'
    if (status === 'proposed')
      return 'validator inactive; <a target="_blank" href="https://explorer.near.org/nodes/proposals">back soon?</a>'
    return 'validator inactive; <a target="_blank" href="https://docs.near.org/docs/validator/delegation">pick a new one</a>'
}

  window.renderers.push(async function renderAccounts({ accounts }) {
    if (!accounts) return

    const container = document.querySelector('#accounts')
    if (!container) return

    const accountsHtml = await Promise.all(accounts.map(
      ({
        wallet_location,
        public_key, // possibly undefined
        account_name,
        starting_balance,
        current_balance,
        lockup_contract,
        delegated_to, // possibly undefined
        validator_status, // possibly undefined
        ...extra
      }) => (`
        <div
           class="account ${!delegated_to
             ? 'undelegated'
             : `validator-${validator_status}`
           }"
           id=${account_name}
        >
          <header class="account__header">
            <div>
              <h2 class="account__location">${wallet_location}</h2>
              <div class="account__validator-status">
                <span class="icon"></span>
                <span>${
                  displayValidatorStatus(validator_status, current_balance - starting_balance)
                }</span>
              </div>
            </div>
            <div class="account__actions">
              <a
                href="#edit=${account_name}"
                class="button button--cta button-size--small"
              >
                Edit
              </a>
            </div>
          </header>
          <div class="account__body">
            ${!public_key ? '' : `
              <div class="account__datum">
                <label>Public Key</label>
                <div class="ellipsis" title="${public_key}">
                  ${public_key}
                </div>
              </div>
            `}
            <div class="account__datum">
              <label>Account Name</label>
              ${link(account_name)}
            </div>
          </div>
          <footer class="account__footer ${
            openAccountDetails[account_name] ? "open" : ""
          }">
            <div class="account__details">
              <div class="account__datum">
                <label>Starting Balance</label>
                ${window.utils.formatLargeNum(starting_balance)}
              </div>
              <div class="account__datum">
                <label>Current Balance</label>
                ${window.utils.formatLargeNum(current_balance)}
              </div>
              <div class="account__datum">
                <label>Lockup Contract</label>
                ${link(lockup_contract)}
              </div>
              ${!delegated_to ? '' : `<div class="account__datum">
                <label>Delegated to</label>
                ${link(delegated_to)}
              </div>`}
              ${Object.entries(extra).map(([key, value]) => `<div class="account__datum">
                <label>${key}</label>
                <div class="ellipsis" title="${value}">${value}</div>
              </div>`).join('')}
            </div>
            <button class="full-width button-size--small" data-behavior="openAccountDetails">
              <span>details</span>
            </button>
          </footer>
        </div>
      `)
    ))

    container.innerHTML = accountsHtml.join('')
  })
</script>
